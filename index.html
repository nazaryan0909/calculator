<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QuickChat – PIN, Delete, Theme</title>
<style>
  :root {
    /* DARK (default) */
    --bg:#0b0f14; --panel:#121821; --muted:#93a1b1; --text:#e6edf3; --brand:#5da0ff; --border:#1e2633; --bubble:#0f1826; --bubbleMe:#0e203a; --bubbleMeBorder:#234a96;
  }
  [data-theme="light"]{
    --bg:#f7f9fc; --panel:#ffffff; --muted:#5d6b7a; --text:#0b1625; --brand:#2b6cff; --border:#dde5ee; --bubble:#f1f5fb; --bubbleMe:#e8f0ff; --bubbleMeBorder:#bcd0ff;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Arial}
  header{padding:12px;background:linear-gradient(180deg,rgba(14,20,32,.7),transparent)}
  .row{max-width:940px;margin:0 auto;display:flex;gap:8px;align-items:center;padding:0 12px}
  h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.2px}
  #themeBtn{margin-left:auto;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);cursor:pointer}
  main{max-width:940px;margin:0 auto;padding:14px}
  #card{border:1px solid var(--border);background:var(--panel);border-radius:14px;overflow:hidden}
  #top{display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);flex-wrap:wrap}
  #room,#name{padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text);min-width:160px}
  #share{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text);cursor:pointer}
  #msgs{height:62vh;min-height:360px;overflow:auto;padding:12px;scroll-behavior:smooth}
  .msg{margin:8px 0;max-width:86%;display:flex;gap:8px}
  .me{margin-left:auto;justify-content:flex-end}
  .bubble{display:inline-block;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--bubble)}
  .bubble.me{background:var(--bubbleMe);border-color:var(--bubbleMeBorder)}
  .meta{font-size:12px;color:var(--muted);margin-top:4px}
  .col{display:flex;flex-direction:column}
  .actions{display:flex;gap:6px;align-items:center}
  .btn-icon{border:1px solid var(--border);background:transparent;color:var(--muted);border-radius:8px;padding:4px 8px;cursor:pointer}
  .btn-icon:hover{color:var(--text)}
  form{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border);background:var(--bg)}
  input[type=text],input[type=password]{flex:1;padding:12px 12px;border-radius:12px;border:1px solid var(--border);background:var(--bg);color:var(--text)}
  button{padding:12px 16px;border-radius:12px;border:1px solid var(--border);background:var(--brand);color:#071223;font-weight:700;cursor:pointer}
  #link{font-family:ui-monospace,Consolas,monospace;color:var(--brand);user-select:all}
  .pill{display:inline-flex;gap:6px;align-items:center;font-size:12px;color:var(--muted);background:var(--bg);border:1px solid var(--border);border-radius:999px;padding:6px 10px}
  .spacer{flex:1}
  @media (max-width:560px){ #msgs{height:58vh} }

  /* PIN overlay */
  #pinOverlay{
    position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;
    align-items:center;justify-content:center;gap:12px;z-index:9999
  }
  #pinBox{display:flex;flex-direction:column;align-items:center;gap:10px;background:var(--panel);border:1px solid var(--border);padding:18px;border-radius:12px}
  #pinInput{font-size:2rem;padding:10px;width:180px;text-align:center;border:1px solid var(--border);border-radius:10px;background:var(--bg);color:var(--text);letter-spacing:0.3em}
  #pinErr{height:1em;color:#ff6b6b}
  #lockHint{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <!-- PIN gate -->
  <div id="pinOverlay" aria-modal="true" role="dialog">
    <div id="pinBox">
      <h2 style="margin:0">Enter 6-digit PIN</h2>
      <input id="pinInput" type="password" inputmode="numeric" maxlength="6" autocomplete="one-time-code" />
      <button id="pinBtn">Unlock</button>
      <div id="pinErr"></div>
      <div id="lockHint">Auto-locks after 1 minute of inactivity</div>
    </div>
  </div>

  <header>
    <div class="row">
      <h1>QuickChat</h1>
      <button id="themeBtn" aria-pressed="false">🌙 Dark</button>
    </div>
  </header>

  <main aria-hidden="true" id="app">
    <div id="card">
      <div id="top">
        <label class="pill">Room
          <input id="room" type="text" placeholder="public" />
        </label>
        <label class="pill">Name
          <input id="name" type="text" placeholder="anon" />
        </label>
        <button id="share" title="Copy invite link">Copy Invite</button>
        <span class="spacer"></span>
        <span class="pill">Link: <span id="link"></span></span>
      </div>

      <div id="msgs" aria-live="polite"></div>

      <form id="form" autocomplete="off">
        <input id="text" type="text" placeholder="Type a message…  (Shift+Enter for newline)" />
        <button id="send" type="submit">Send ↵</button>
      </form>
    </div>
  </main>

  <script type="module">
    // =========================
    //  THEME TOGGLE (light/dark)
    // =========================
    const themeBtn = document.getElementById("themeBtn");
    const savedTheme = localStorage.qc_theme || "dark";
    document.documentElement.setAttribute("data-theme", savedTheme);
    updateThemeButton(savedTheme);
    themeBtn.addEventListener("click", ()=>{
      const next = (document.documentElement.getAttribute("data-theme")==="dark")?"light":"dark";
      document.documentElement.setAttribute("data-theme", next);
      localStorage.qc_theme = next;
      updateThemeButton(next);
    });
    function updateThemeButton(mode){
      themeBtn.textContent = (mode==="dark")?"🌙 Dark":"☀️ Light";
      themeBtn.setAttribute("aria-pressed", mode==="dark" ? "true":"false");
    }

    // =========================
    //  PIN + AUTO-LOCK SETTINGS
    // =========================
    const CHAT_PIN = "505051";       // your 6-digit PIN
    const AUTOLOCK_MS = 60_000;      // 1 minute

    const pinOverlay = document.getElementById("pinOverlay");
    const pinInput   = document.getElementById("pinInput");
    const pinBtn     = document.getElementById("pinBtn");
    const pinErr     = document.getElementById("pinErr");
    const appMain    = document.getElementById("app");

    let unlocked = false;
    let lastActivity = Date.now();

    function showPin(msg=""){
      pinErr.textContent = msg;
      pinOverlay.style.display = "flex";
      appMain.setAttribute("aria-hidden","true");
      unlocked = false;
      setTimeout(()=>pinInput.focus(), 50);
    }
    function hidePin(){
      pinOverlay.style.display = "none";
      appMain.removeAttribute("aria-hidden");
      unlocked = true;
      lastActivity = Date.now();
    }
    function tryUnlock(){
      const code = pinInput.value.trim();
      if(code === CHAT_PIN){ hidePin(); pinInput.value=""; }
      else { pinErr.textContent = "Incorrect PIN"; pinInput.select(); }
    }
    pinBtn.addEventListener("click", tryUnlock);
    pinInput.addEventListener("keydown", e=>{
      if(e.key === "Enter") { e.preventDefault(); tryUnlock(); }
    });
    ["click","keydown","scroll","mousemove","touchstart"].forEach(evt=>{
      document.addEventListener(evt, ()=>{ lastActivity = Date.now(); }, {passive:true});
    });
    setInterval(()=>{
      if(unlocked && Date.now() - lastActivity > AUTOLOCK_MS){ showPin(); }
    }, 1000);
    showPin(); // gate on load

    // =========================
    //  FIREBASE CHAT
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyDyO8Um7UzvOOm0ki7WvGuwiqbNAyS8ro8",
      authDomain: "calculator-l.firebaseapp.com",
      projectId: "calculator-l",
      storageBucket: "calculator-l.firebasestorage.app",
      messagingSenderId: "55334370820",
      appId: "1:55334370820:web:5f38db1aeffe33d44a3f51",
      measurementId: "G-FGK3V66H34"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, query, orderBy, limit,
      onSnapshot, serverTimestamp, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = id => document.getElementById(id);
    const roomInput = $("room"), nameInput = $("name"),
          msgsDiv   = $("msgs"), textBox   = $("text"), form = $("form"),
          linkSpan  = $("link"), shareBtn  = $("share");

    const url = new URL(location.href);
    roomInput.value = url.searchParams.get("room") || localStorage.qc_room || "public";
    nameInput.value = localStorage.qc_name || "";
    function room(){ return roomInput.value.trim() || "public"; }
    function nick(){ return (nameInput.value.trim() || "anon").slice(0,24); }

    function setShareLink(){
      const base = location.origin + location.pathname;
      const link = `${base}?room=${encodeURIComponent(room())}`;
      linkSpan.textContent = link;
    }
    setShareLink();

    nameInput.addEventListener("change", ()=> localStorage.qc_name = nick());
    roomInput.addEventListener("change", ()=> {
      localStorage.qc_room = room(); setShareLink(); subscribe();
    });

    shareBtn.addEventListener("click", async ()=>{
      try {
        await navigator.clipboard.writeText(linkSpan.textContent);
        shareBtn.textContent = "Copied!";
        setTimeout(()=>shareBtn.textContent="Copy Invite",1200);
      } catch {
        alert("Copy failed — long-press the link to select & copy.");
      }
    });

    let stop = null;
    let currentUid = null;

    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, u => {
      if (u) { currentUid = u.uid; subscribe(); }
    });

    function subscribe(){
      if (stop){ stop(); stop=null; }
      msgsDiv.innerHTML = "";
      const q = query(collection(db,"rooms", room(), "msgs"), orderBy("ts","asc"), limit(500));
      stop = onSnapshot(q, snap=>{
        msgsDiv.innerHTML = "";
        snap.forEach(d => render(d.id, d.data()));
        msgsDiv.scrollTop = msgsDiv.scrollHeight;
      });
    }

    form.addEventListener("submit", async e=>{
      e.preventDefault();
      if(!unlocked){ showPin(); return; }
      const text = textBox.value.replace(/\s+$/,"");
      if(!text) return;
      await addDoc(collection(db,"rooms", room(), "msgs"), {
        t: text.slice(0,2000),
        n: nick(),
        uid: currentUid,
        ts: serverTimestamp()
      });
      textBox.value = "";
      lastActivity = Date.now();
    });

    textBox.addEventListener("keydown", e=>{
      if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault(); $("send").click();
      }
    });

    function esc(s){ return s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

    function render(id, m){
      const mine = m.uid && currentUid && m.uid === currentUid;
      const wrap = document.createElement("div");
      wrap.className = "msg" + (mine?" me":"");

      const col = document.createElement("div");
      col.className = "col";

      const bubble = document.createElement("div");
      bubble.className = "bubble" + (mine?" me":"");
      const msg = esc(m.t||"")
        .replace(/:\)/g,"😊").replace(/:\(/g,"🙁").replace(/<3/g,"❤️")
        .replace(/\n/g,"<br>");
      bubble.innerHTML = msg;

      const meta = document.createElement("div");
      meta.className = "meta";
      const time = m.ts?.toDate ? m.ts.toDate() : null;
      meta.textContent = `${m.n||"anon"} • ${time ? time.toLocaleString() : "sending…"}`;

      col.appendChild(bubble);
      col.appendChild(meta);

      if(mine){
        const actions = document.createElement("div");
        actions.className = "actions";
        const del = document.createElement("button");
        del.className = "btn-icon";
        del.title = "Delete message for everyone";
        del.textContent = "🗑 Delete";
        del.addEventListener("click", async ()=>{
          if(confirm("Delete this message for everyone?")){
            try{
              await deleteDoc(doc(db,"rooms", room(), "msgs", id));
            }catch(e){ alert("Delete failed: " + e.message); }
          }
        });
        actions.appendChild(del);
        col.appendChild(actions);
      }

      wrap.appendChild(col);
      msgsDiv.appendChild(wrap);
      lastActivity = Date.now();
    }
  </script>
</body>
</html>
