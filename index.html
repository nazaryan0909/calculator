<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QuickChat ‚Äì PIN, Delete, Theme, Reactions</title>
<style>
  :root {
    /* DARK (default) */
    --bg:#0b0f14; --panel:#121821; --muted:#93a1b1; --text:#e6edf3; --brand:#5da0ff; --border:#1e2633; --bubble:#0f1826; --bubbleMe:#0e203a; --bubbleMeBorder:#234a96;
  }
  [data-theme="light"]{
    --bg:#f7f9fc; --panel:#ffffff; --muted:#5d6b7a; --text:#0b1625; --brand:#2b6cff; --border:#dde5ee; --bubble:#f1f5fb; --bubbleMe:#e8f0ff; --bubbleMeBorder:#bcd0ff;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Arial}
  header{padding:12px;background:linear-gradient(180deg,rgba(14,20,32,.7),transparent)}
  .row{max-width:940px;margin:0 auto;display:flex;gap:8px;align-items:center;padding:0 12px}
  h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.2px}
  #themeBtn{margin-left:auto;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);cursor:pointer}
  main{max-width:940px;margin:0 auto;padding:14px}
  #card{border:1px solid var(--border);background:var(--panel);border-radius:14px;overflow:hidden}
  #top{display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);flex-wrap:wrap}
  #room,#name{padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text);min-width:160px}
  #share{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text);cursor:pointer}
  #msgs{height:62vh;min-height:360px;overflow:auto;padding:12px;scroll-behavior:smooth}
  .msg{margin:8px 0;max-width:86%;display:flex;gap:8px}
  .me{margin-left:auto;justify-content:flex-end}
  .bubble{display:inline-block;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--bubble)}
  .bubble.me{background:var(--bubbleMe);border-color:var(--bubbleMeBorder)}
  .meta{font-size:12px;color:var(--muted);margin-top:4px}
  .col{display:flex;flex-direction:column}
  .reactions{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:transparent;font-size:13px;color:var(--muted)}
  .pill.mine{border-color:var(--brand);color:var(--text)}
  form{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border);background:var(--bg)}
  input[type=text],input[type=password]{flex:1;padding:12px 12px;border-radius:12px;border:1px solid var(--border);background:var(--bg);color:var(--text)}
  button{padding:12px 16px;border-radius:12px;border:1px solid var(--border);background:var(--brand);color:#071223;font-weight:700;cursor:pointer}
  #link{font-family:ui-monospace,Consolas,monospace;color:var(--brand);user-select:all}
  .tag{display:inline-flex;gap:6px;align-items:center;font-size:12px;color:var(--muted);background:var(--bg);border:1px solid var(--border);border-radius:999px;padding:6px 10px}
  .spacer{flex:1}
  @media (max-width:560px){ #msgs{height:58vh} }

  /* PIN overlay */
  #pinOverlay{
    position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;
    align-items:center;justify-content:center;gap:12px;z-index:9999
  }
  #pinBox{display:flex;flex-direction:column;align-items:center;gap:10px;background:var(--panel);border:1px solid var(--border);padding:18px;border-radius:12px}
  #pinInput{font-size:2rem;padding:10px;width:180px;text-align:center;border:1px solid var(--border);border-radius:10px;background:var(--bg);color:var(--text);letter-spacing:0.3em}
  #pinErr{height:1em;color:#ff6b6b}
  #lockHint{font-size:12px;color:var(--muted)}

  /* Bottom sheet for reactions + delete */
  #sheet{
    position:fixed;left:0;right:0;bottom:-260px;background:var(--panel);
    border-top:1px solid var(--border);box-shadow:0 -6px 30px rgba(0,0,0,.25);
    border-top-left-radius:14px;border-top-right-radius:14px;z-index:9998;
    transition:bottom .2s ease; padding:12px
  }
  #sheet.show{bottom:0}
  #sheetBar{width:40px;height:5px;background:var(--border);border-radius:4px;margin:6px auto}
  #sheetRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:8px 0}
  .emojiBtn{font-size:24px;line-height:1;border:1px solid var(--border);background:transparent;border-radius:10px;padding:8px 10px;cursor:pointer}
  #sheetDel{display:block;margin:6px auto 2px;padding:8px 14px;border-radius:10px;border:1px solid var(--border);background:#ff5c5c;color:#1d0000;font-weight:700;cursor:pointer}
</style>
</head>
<body>
  <!-- PIN gate -->
  <div id="pinOverlay" aria-modal="true" role="dialog">
    <div id="pinBox">
      <h2 style="margin:0">Enter 6-digit PIN</h2>
      <input id="pinInput" type="password" inputmode="numeric" maxlength="6" autocomplete="one-time-code" />
      <button id="pinBtn">Unlock</button>
      <div id="pinErr"></div>
      <div id="lockHint">Auto-locks after 1 minute of inactivity</div>
    </div>
  </div>

  <header>
    <div class="row">
      <h1>QuickChat</h1>
      <button id="themeBtn" aria-pressed="false">üåô Dark</button>
    </div>
  </header>

  <main aria-hidden="true" id="app">
    <div id="card">
      <div id="top">
        <label class="tag">Room
          <input id="room" type="text" placeholder="public" />
        </label>
        <label class="tag">Name
          <input id="name" type="text" placeholder="anon" />
        </label>
        <button id="share" title="Copy invite link">Copy Invite</button>
        <span class="spacer"></span>
        <span class="tag">Link: <span id="link"></span></span>
      </div>

      <div id="msgs" aria-live="polite"></div>

      <form id="form" autocomplete="off">
        <input id="text" type="text" placeholder="Type a message‚Ä¶  (Shift+Enter for newline)" />
        <button id="send" type="submit">Send ‚Üµ</button>
      </form>
    </div>
  </main>

  <!-- Bottom sheet -->
  <div id="sheet" aria-hidden="true">
    <div id="sheetBar"></div>
    <div style="text-align:center;color:var(--muted);font-size:12px;margin-top:4px">React or manage</div>
    <div id="sheetRow"></div>
    <button id="sheetDel" style="display:none">üóë Delete for everyone</button>
  </div>

  <script type="module">
    // =========================
    //  THEME TOGGLE
    // =========================
    const themeBtn = document.getElementById("themeBtn");
    const savedTheme = localStorage.qc_theme || "dark";
    document.documentElement.setAttribute("data-theme", savedTheme);
    updateThemeButton(savedTheme);
    themeBtn.addEventListener("click", ()=>{
      const next = (document.documentElement.getAttribute("data-theme")==="dark")?"light":"dark";
      document.documentElement.setAttribute("data-theme", next);
      localStorage.qc_theme = next;
      updateThemeButton(next);
    });
    function updateThemeButton(mode){
      themeBtn.textContent = (mode==="dark")?"üåô Dark":"‚òÄÔ∏è Light";
      themeBtn.setAttribute("aria-pressed", mode==="dark" ? "true":"false");
    }

    // =========================
    //  PIN + AUTO-LOCK
    // =========================
    const CHAT_PIN = "505051";
    const AUTOLOCK_MS = 60_000;

    const pinOverlay = document.getElementById("pinOverlay");
    const pinInput   = document.getElementById("pinInput");
    const pinBtn     = document.getElementById("pinBtn");
    const pinErr     = document.getElementById("pinErr");
    const appMain    = document.getElementById("app");

    let unlocked = false;
    let lastActivity = Date.now();

    function showPin(msg=""){
      pinErr.textContent = msg;
      pinOverlay.style.display = "flex";
      appMain.setAttribute("aria-hidden","true");
      unlocked = false;
      setTimeout(()=>pinInput.focus(), 50);
    }
    function hidePin(){
      pinOverlay.style.display = "none";
      appMain.removeAttribute("aria-hidden");
      unlocked = true;
      lastActivity = Date.now();
    }
    function tryUnlock(){
      const code = pinInput.value.trim();
      if(code === CHAT_PIN){ hidePin(); pinInput.value=""; }
      else { pinErr.textContent = "Incorrect PIN"; pinInput.select(); }
    }
    pinBtn.addEventListener("click", tryUnlock);
    pinInput.addEventListener("keydown", e=>{
      if(e.key === "Enter") { e.preventDefault(); tryUnlock(); }
    });
    ["click","keydown","scroll","mousemove","touchstart"].forEach(evt=>{
      document.addEventListener(evt, ()=>{ lastActivity = Date.now(); }, {passive:true});
    });
    setInterval(()=>{ if(unlocked && Date.now()-lastActivity > AUTOLOCK_MS) showPin(); }, 1000);
    showPin();

    // =========================
    //  FIREBASE
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyDyO8Um7UzvOOm0ki7WvGuwiqbNAyS8ro8",
      authDomain: "calculator-l.firebaseapp.com",
      projectId: "calculator-l",
      storageBucket: "calculator-l.firebasestorage.app",
      messagingSenderId: "55334370820",
      appId: "1:55334370820:web:5f38db1aeffe33d44a3f51",
      measurementId: "G-FGK3V66H34"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, query, orderBy, limit,
      onSnapshot, serverTimestamp, deleteDoc, doc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = id => document.getElementById(id);
    const roomInput = $("room"), nameInput = $("name"),
          msgsDiv   = $("msgs"), textBox   = $("text"), form = $("form"),
          linkSpan  = $("link"), shareBtn  = $("share");

    const url = new URL(location.href);
    roomInput.value = url.searchParams.get("room") || localStorage.qc_room || "public";
    nameInput.value = localStorage.qc_name || "";
    function room(){ return roomInput.value.trim() || "public"; }
    function nick(){ return (nameInput.value.trim() || "anon").slice(0,24); }

    function setShareLink(){
      const base = location.origin + location.pathname;
      linkSpan.textContent = `${base}?room=${encodeURIComponent(room())}`;
    }
    setShareLink();

    nameInput.addEventListener("change", ()=> localStorage.qc_name = nick());
    roomInput.addEventListener("change", ()=> {
      localStorage.qc_room = room(); setShareLink(); subscribe();
    });

    shareBtn.addEventListener("click", async ()=>{
      try { await navigator.clipboard.writeText(linkSpan.textContent);
            shareBtn.textContent = "Copied!"; setTimeout(()=>shareBtn.textContent="Copy Invite",1200);
      } catch { alert("Copy failed ‚Äî long-press the link to select & copy."); }
    });

    let stop = null;
    let currentUid = null;
    const reactionUnsubs = new Map(); // messageId -> unsubscribe

    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, u => { if (u) { currentUid = u.uid; subscribe(); } });

    function subscribe(){
      // clear old reaction listeners
      reactionUnsubs.forEach(unsub => unsub && unsub());
      reactionUnsubs.clear();

      if (stop){ stop(); stop=null; }
      msgsDiv.innerHTML = "";
      const q = query(collection(db,"rooms", room(), "msgs"), orderBy("ts","asc"), limit(500));
      stop = onSnapshot(q, snap=>{
        msgsDiv.innerHTML = "";
        snap.forEach(d => renderMessage(d.id, d.data()));
        msgsDiv.scrollTop = msgsDiv.scrollHeight;
      });
    }

    form.addEventListener("submit", async e=>{
      e.preventDefault();
      if(!unlocked){ showPin(); return; }
      const text = textBox.value.replace(/\s+$/,"");
      if(!text) return;
      await addDoc(collection(db,"rooms", room(), "msgs"), {
        t: text.slice(0,2000), n: nick(), uid: currentUid, ts: serverTimestamp()
      });
      textBox.value = "";
      lastActivity = Date.now();
    });

    textBox.addEventListener("keydown", e=>{
      if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); $("send").click(); }
    });

    function esc(s){ return s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

    // ====== Bottom sheet logic ======
    const sheet = document.getElementById("sheet");
    const sheetRow = document.getElementById("sheetRow");
    const sheetDel = document.getElementById("sheetDel");
    const EMOJIS = ["üëç","‚ù§Ô∏è","üòÇ","üòÆ","üò¢","üî•"];
    let sheetMsgId = null;
    let sheetMsgMine = false;

    function openSheet(msgId, mine){
      sheetMsgId = msgId; sheetMsgMine = mine;
      sheetRow.innerHTML = "";
      EMOJIS.forEach(e=>{
        const b = document.createElement("button");
        b.className = "emojiBtn";
        b.textContent = e;
        b.addEventListener("click", ()=> toggleReaction(msgId, e));
        sheetRow.appendChild(b);
      });
      sheetDel.style.display = mine ? "block":"none";
      sheet.classList.add("show");
      sheet.setAttribute("aria-hidden","false");
    }
    function closeSheet(){
      sheet.classList.remove("show");
      sheet.setAttribute("aria-hidden","true");
      sheetMsgId = null; sheetMsgMine = false;
    }
    // tap outside to close
    document.addEventListener("click", (e)=>{
      if (sheet.classList.contains("show")){
        const within = e.target.closest("#sheet");
        if (!within) closeSheet();
      }
    });

    async function toggleReaction(msgId, emoji){
      if (!currentUid) return;
      const rDoc = doc(db, "rooms", room(), "msgs", msgId, "reactions", currentUid);
      // We don't read first; set the new emoji, and if the same as already there, unset.
      // Simple toggle approach: try to set; if already same, delete.
      try {
        await setDoc(rDoc, { e: emoji, uid: currentUid, ts: serverTimestamp() });
      } catch(e){ console.error(e); }
    }

    // ====== render + listeners (incl. long-press) ======
    function attachLongPress(el, onLong){
      let t;
      el.addEventListener("touchstart", ()=>{ t=setTimeout(onLong, 450); }, {passive:true});
      ["touchend","touchmove","touchcancel"].forEach(ev=> el.addEventListener(ev, ()=> clearTimeout(t), {passive:true}));
      el.addEventListener("contextmenu", (e)=>{ e.preventDefault(); onLong(); });
      el.addEventListener("mousedown", (e)=>{ if(e.button===2){ e.preventDefault(); onLong(); }});
    }

    async function renderMessage(id, m){
      const mine = m.uid && currentUid && m.uid === currentUid;

      const wrap = document.createElement("div");
      wrap.className = "msg" + (mine?" me":"");

      const col = document.createElement("div");
      col.className = "col";

      const bubble = document.createElement("div");
      bubble.className = "bubble" + (mine?" me":"");
      const msg = esc(m.t||"").replace(/:\)/g,"üòä").replace(/:\(/g,"üôÅ").replace(/<3/g,"‚ù§Ô∏è").replace(/\n/g,"<br>");
      bubble.innerHTML = msg;

      // Long-press to open sheet
      attachLongPress(bubble, ()=> openSheet(id, mine));

      const meta = document.createElement("div");
      meta.className = "meta";
      const time = m.ts?.toDate ? m.ts.toDate() : null;
      meta.textContent = `${m.n||"anon"} ‚Ä¢ ${time ? time.toLocaleString() : "sending‚Ä¶"}`;

      const reactsDiv = document.createElement("div");
      reactsDiv.className = "reactions";

      col.appendChild(bubble);
      col.appendChild(meta);
      col.appendChild(reactsDiv);

      // If it's mine, the Delete button also appears in the sheet (not here)

      wrap.appendChild(col);
      msgsDiv.appendChild(wrap);
      lastActivity = Date.now();

      // Subscribe to reactions subcollection to update pills live
      const unsub = onSnapshot(collection(db,"rooms", room(), "msgs", id, "reactions"), snap=>{
        // Count per emoji + whether current user reacted
        const counts = {};
        let myEmoji = null;
        snap.forEach(d=>{
          const r = d.data();
          if (!r?.e) return;
          counts[r.e] = (counts[r.e]||0)+1;
          if (d.id === currentUid) myEmoji = r.e;
        });
        reactsDiv.innerHTML = "";
        Object.entries(counts).sort((a,b)=>b[1]-a[1]).forEach(([emoji, count])=>{
          const pill = document.createElement("span");
          pill.className = "pill" + (myEmoji===emoji?" mine":"");
          pill.textContent = `${emoji} ${count}`;
          pill.addEventListener("click", ()=> toggleReaction(id, emoji));
          reactsDiv.appendChild(pill);
        });
      });
      // Track to clean up on room change
      reactionUnsubs.set(id, unsub);
    }

    // Bottom sheet delete action
    sheetDel.addEventListener("click", async ()=>{
      if (!sheetMsgId) return;
      if (confirm("Delete this message for everyone?")){
        try {
          await deleteDoc(doc(db,"rooms", room(), "msgs", sheetMsgId));
          closeSheet();
        } catch(e){ alert("Delete failed: " + e.message); }
      }
    });
  </script>
</body>
</html>
