<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QuickChat ‚Äì Telegram-style</title>
<style>
  :root{
    --bg:#0c1117; --panel:#101822; --muted:#8aa0b6; --text:#e7eef6; --brand:#4ea1ff; --border:#1f2a3a;
    --bubble:#142233; --bubbleMe:#15324e; --bubbleMeBorder:#2b68b3;
  }
  [data-theme="light"]{
    --bg:#f6f9fd; --panel:#ffffff; --muted:#5c6a79; --text:#0b1625; --brand:#2b6cff; --border:#dfe7f1;
    --bubble:#eef3fb; --bubbleMe:#e6efff; --bubbleMeBorder:#bcd0ff;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Arial}

  /* Top app bar */
  header{position:sticky;top:0;z-index:10;background:var(--panel);border-bottom:1px solid var(--border)}
  .row{max-width:1100px;margin:0 auto;display:flex;gap:8px;align-items:center;justify-content:flex-start;padding:10px 12px}
  h1{margin:0;font-size:17px;font-weight:700}
  #chatTitle{margin-left:8px;font-weight:600;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:45vw}
  #themeBtn,#logoutBtn,#menuBtn{
    padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer
  }
  #themeBtn{margin-left:auto}

  main{max-width:1100px;margin:0 auto;padding:0 12px;height:calc(100dvh - 58px);display:flex;gap:12px}

  /* Drawer (friends + requests) */
  #drawer{position:relative;width:300px;min-width:260px}
  #left{
    position:sticky;top:12px;height:calc(100dvh - 82px);overflow:auto;
    border:1px solid var(--border);background:var(--panel);border-radius:14px
  }
  #friendsHead{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border)}
  #friends,#reqs{max-height:none;overflow:visible}
  .friend,.req{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border)}
  .friend:hover,.req:hover{background:rgba(255,255,255,.04)}
  .small{color:var(--muted);font-size:12px}
  .rowbtns{display:flex;gap:6px}
  .btn{padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer}
  .btn-warn{background:#ff5c5c;color:#1d0000;border-color:#e54}
  #reqsHead{padding:8px 12px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);font-weight:600;display:flex;align-items:center;gap:8px}
  #addFriendForm{display:flex;gap:6px;padding:10px 12px;border-top:1px solid var(--border)}
  #addU{flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text)}
  #badge{display:inline-flex;min-width:18px;height:18px;border-radius:9px;background:#ff5c5c;color:#fff;font-size:12px;align-items:center;justify-content:center;padding:0 6px;margin-left:6px}

  /* Chat column */
  #card{flex:1;display:flex;flex-direction:column;height:100%;
        border:1px solid var(--border);background:var(--panel);border-radius:14px}
  #top{display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);flex-wrap:wrap}
  #search{margin-left:auto;min-width:160px;padding:8px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text)}
  #msgs{flex:1;overflow:auto;padding:12px;scroll-behavior:smooth}
  #typing{padding:6px 12px;color:var(--muted);font-size:12px}

  .msg{margin:8px 0;max-width:88%;display:flex;gap:8px}
  .me{margin-left:auto;justify-content:flex-end}
  .bubble{display:inline-block;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--bubble)}
  .bubble.me{background:var(--bubbleMe);border-color:var(--bubbleMeBorder)}
  .meta{font-size:12px;color:var(--muted);margin-top:4px}
  .col{display:flex;flex-direction:column}
  .reactions{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:transparent;font-size:13px;color:var(--muted)}
  .pill.mine{border-color:var(--brand);color:var(--text)}

  #emojiBar{display:flex;gap:6px;padding:6px 12px;border-top:1px dashed var(--border)}
  .emojiBtn{font-size:20px;line-height:1;border:1px solid var(--border);background:transparent;border-radius:10px;padding:6px 8px;cursor:pointer}

  form#form{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border);background:var(--panel)}
  input[type=text]{flex:1;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--bg);color:var(--text)}
  button#send{padding:12px 16px;border-radius:12px;border:1px solid var(--border);background:var(--brand);color:#071223;font-weight:700;cursor:pointer}

  /* Auth modal */
  #authModal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:9999}
  #authCard{width:360px;max-width:92vw;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px}
  #authCard h3{margin:6px 0 8px}
  #authCard .row{display:flex;flex-direction:column;gap:8px}
  #authErr{color:#ff6b6b;min-height:1em}

  /* --- Mobile: Telegram-like --- */
  @media (max-width: 900px){
    #menuBtn{display:inline-block}
    #drawer{
      position:fixed; inset:0 auto 0 0; width:86%; max-width:360px; z-index:20;
      transform:translateX(-100%); transition:.2s ease transform;
    }
    #drawer.open{ transform:translateX(0) }
    #drawerOverlay{
      position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:19; display:none;
    }
    #drawerOverlay.show{ display:block }

    main{padding:0; height:calc(100dvh - 58px)}
    #card{border-radius:0}
    #search{display:none}
    #chatTitle{max-width:38vw}
  }

  /* Desktop tweaks */
  @media (min-width: 901px){
    #menuBtn{display:none}
    #drawerOverlay{display:none!important}
  }
</style>
</head>
<body>
  <script src="https://unpkg.com/eruda"></script>
  <script>eruda.init();</script>

  <!-- Auth (username + password) -->
  <div id="authModal" style="display:none">
    <div id="authCard">
      <h3>Sign in</h3>
      <form id="authForm" class="row">
        <input id="username" placeholder="Username (a-z, 0-9, _)" maxlength="20" autocomplete="username">
        <input id="password" type="password" placeholder="Password (min 6)" autocomplete="current-password">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="loginBtn"  type="button" style="flex:1">Log in</button>
          <button id="signupBtn" type="button" style="flex:1">Create account</button>
        </div>
        <div id="authErr"></div>
      </form>
    </div>
  </div>

  <header>
    <div class="row">
      <button id="menuBtn" title="Friends">‚ò∞</button>
      <h1>QuickChat</h1>
      <span id="chatTitle"></span>
      <button id="themeBtn" aria-pressed="false">üåô Dark</button>
      <button id="logoutBtn" title="Sign out">Sign out</button>
    </div>
  </header>

  <main id="app">
    <div id="drawerOverlay"></div>
    <aside id="drawer">
      <div id="left">
        <div id="friendsHead">
          <strong>Friends</strong>
          <span style="margin-left:auto" class="small">Requests <span id="badge" style="display:none">0</span></span>
        </div>
        <div id="friends"></div>
        <div id="reqsHead">Incoming requests</div>
        <div id="reqs"></div>
        <form id="addFriendForm">
          <input id="addU" placeholder="Add by username" />
          <button type="submit">Add</button>
        </form>
      </div>
    </aside>

    <section id="card">
      <div id="top">
        <div id="chatWith">Pick a friend to start chatting</div>
        <input id="search" placeholder="Search messages‚Ä¶" />
      </div>
      <div id="msgs" aria-live="polite"></div>
      <div id="typing"></div>
      <div id="emojiBar">
        <button class="emojiBtn" type="button">üòÄ</button><button class="emojiBtn" type="button">üòÇ</button><button class="emojiBtn" type="button">‚ù§Ô∏è</button><button class="emojiBtn" type="button">üëç</button><button class="emojiBtn" type="button">üî•</button><button class="emojiBtn" type="button">üòÆ</button>
      </div>
      <form id="form" autocomplete="off">
        <input id="text" type="text" placeholder="Type a message‚Ä¶  (Enter to send, Shift+Enter = newline)" />
        <button id="send" type="submit">Send ‚Üµ</button>
      </form>
    </section>
  </main>

<script type="module">
  // ---- Firebase config (yours) ----
  const firebaseConfig = {
    apiKey: "AIzaSyDyO8Um7UzvOOm0ki7WvGuwiqbNAyS8ro8",
    authDomain: "calculator-l.firebaseapp.com",
    projectId: "calculator-l",
    storageBucket: "calculator-l.firebasestorage.app",
    messagingSenderId: "55334370820",
    appId: "1:55334370820:web:5f38db1aeffe33d44a3f51",
    measurementId: "G-FGK3V66H34"
  };

  // ---- Imports ----
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot,
    query, orderBy, serverTimestamp, deleteDoc, getDocs, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ---- Init ----
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ---- UI ----
  const $ = id => document.getElementById(id);
  const authModal=$("authModal"), authForm=$("authForm"), usernameEl=$("username"), passwordEl=$("password"), loginBtn=$("loginBtn"), signupBtn=$("signupBtn"), authErr=$("authErr");
  const themeBtn=$("themeBtn"), logoutBtn=$("logoutBtn");
  const friendsDiv=$("friends"), reqsDiv=$("reqs"), addFriendForm=$("addFriendForm"), addU=$("addU"), badge=$("badge");
  const chatWith=$("chatWith"), msgsDiv=$("msgs"), form=$("form"), textBox=$("text"), typingDiv=$("typing"), searchBox=$("search");
  const emojiBar=$("emojiBar");
  const menuBtn = $("menuBtn"), drawer = $("drawer"), drawerOverlay = $("drawerOverlay"), chatTitle = $("chatTitle");

  // ===== Drawer open/close (mobile) =====
  function openDrawer(){ drawer.classList.add("open"); drawerOverlay.classList.add("show"); }
  function closeDrawer(){ drawer.classList.remove("open"); drawerOverlay.classList.remove("show"); }
  function closeDrawerIfMobile(){ if (window.matchMedia("(max-width: 900px)").matches) closeDrawer(); }
  menuBtn?.addEventListener("click", openDrawer);
  drawerOverlay?.addEventListener("click", closeDrawer);
  function setChatTitle(name, uname){ chatTitle.textContent = name ? `‚Äî ${name} ${uname||""}` : ""; }

  // ---- Theme ----
  const savedTheme = localStorage.qc_theme || "dark";
  document.documentElement.setAttribute("data-theme", savedTheme);
  themeBtn.textContent = savedTheme==="dark" ? "üåô Dark" : "‚òÄÔ∏è Light";
  themeBtn.addEventListener("click", ()=>{
    const next = document.documentElement.getAttribute("data-theme")==="dark" ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", next);
    localStorage.qc_theme = next;
    themeBtn.textContent = next==="dark" ? "üåô Dark" : "‚òÄÔ∏è Light";
  });

  // ---- Username-login helpers ----
  const unameRe = /^[a-z0-9_]{3,20}$/;
  const unameToEmail = u => `${u.toLowerCase()}@app.local`;

  // ---- State ----
  let me = { uid:null, username:null, displayName:null };
  let activeFriend = null;
  let activeFriendName = "";
  let activeFriendUname = "";
  let activeChatId = null;
  let stopMsgs = null, stopReqs = null, stopTypingOther = null;
  let typingTimeout = null;
  const EMOJIS = ["üòÄ","üòÇ","‚ù§Ô∏è","üëç","üî•","üòÆ"];

  // === Helper: stable chat id ===
  function dmId(a,b){ return [a,b].sort().join("_"); }

  // ---- Auth modal helpers ----
  function showAuth(msg=""){ authErr.textContent=msg; authModal.style.display="flex"; }
  function hideAuth(){ authModal.style.display="none"; }
  authForm.addEventListener("submit", e=>e.preventDefault()); // avoid page reload

  signupBtn.onclick = async ()=>{
    authErr.textContent="";
    const u=(usernameEl.value||"").trim().toLowerCase();
    const p=passwordEl.value;
    if(!unameRe.test(u)){ authErr.textContent="Username 3‚Äì20 chars: a‚Äìz 0‚Äì9 _"; return; }
    if(p.length<6){ authErr.textContent="Password ‚â• 6"; return; }
    try{
      const cred=await createUserWithEmailAndPassword(auth, unameToEmail(u), p);
      await updateProfile(cred.user,{displayName:u});
      await setDoc(doc(db,"users",cred.user.uid),{ uid:cred.user.uid, username:u, displayName:u, createdAt:serverTimestamp() });
      await setDoc(doc(db,"usernames",u),{ uid:cred.user.uid, createdAt:serverTimestamp() });
      hideAuth();
    }catch(e){ authErr.textContent=e.message; }
  };

  loginBtn.onclick = async ()=>{
    authErr.textContent="";
    const u=(usernameEl.value||"").trim().toLowerCase();
    const p=passwordEl.value;
    if(!unameRe.test(u)){ authErr.textContent="Enter username"; return; }
    try{ await signInWithEmailAndPassword(auth, unameToEmail(u), p); hideAuth(); }
    catch(e){ authErr.textContent="Login failed: "+e.message; }
  };

  logoutBtn.onclick = async ()=>{ await signOut(auth); location.reload(); };

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ showAuth(); return; }
    const udoc=await getDoc(doc(db,"users",user.uid));
    const data=udoc.data()||{};
    me.uid=user.uid; me.username=data.username||user.displayName?.toLowerCase(); me.displayName=data.displayName||me.username||"me";
    hideAuth();
    await loadFriends();
    subscribeRequestsBadge();
  });

  // ---- Friends & Requests ----
  async function usernameToUid(uname){
    const d=await getDoc(doc(db,"usernames",uname.toLowerCase()));
    return d.exists()? d.data().uid : null;
  }

  async function loadFriends(){
    friendsDiv.innerHTML="";
    const snaps=await getDocs(collection(db,"friends",me.uid,"list"));
    if(snaps.empty){ friendsDiv.innerHTML=`<div class="small" style="padding:10px">No friends yet. Add by username below.</div>`; }
    for(const d of snaps.docs){
      const fuid=d.id;
      const u=await getDoc(doc(db,"users",fuid));
      const name=u.data()?.displayName||"Friend";
      const uname=u.data()?.username ? "@"+u.data().username : "";
      const row=document.createElement("div");
      row.className="friend";
      row.innerHTML=`<div><div>${name}</div><div class="small">${uname}</div></div>
        <div class="rowbtns">
          <button class="btn" id="open_${fuid}">Open</button>
          <button class="btn" id="rm_${fuid}">Remove</button>
          <button class="btn btn-warn" id="blk_${fuid}">Block</button>
        </div>`;
      friendsDiv.appendChild(row);
      $("open_"+fuid).onclick=()=> openDM(fuid,name,uname);
      $("rm_"+fuid).onclick=()=> removeFriend(fuid);
      $("blk_"+fuid).onclick=()=> blockFriend(fuid);
    }
  }

  function subscribeRequestsBadge(){
    if(stopReqs) stopReqs();
    const inbox=collection(db,"friend_reqs", me.uid, "inbox");
    stopReqs = onSnapshot(inbox,(snap)=>{
      const n=snap.size; badge.textContent=String(n);
      badge.style.display = n? "inline-flex":"none";
      // render list
      reqsDiv.innerHTML="";
      if(!n){ reqsDiv.innerHTML=`<div class="small" style="padding:10px">No requests</div>`; return; }
      snap.forEach(async d=>{
        const fromUid=d.id;
        const from=await getDoc(doc(db,"users",fromUid));
        const uname=from.data()?.username||"user";
        const r=document.createElement("div"); r.className="req";
        r.innerHTML=`<div>@${uname}</div>
          <div class="rowbtns">
            <button class="btn" id="acc_${fromUid}">Accept</button>
            <button class="btn" id="dec_${fromUid}">Decline</button>
          </div>`;
        reqsDiv.appendChild(r);
        $("acc_"+fromUid).onclick=()=> acceptRequest(fromUid);
        $("dec_"+fromUid).onclick=()=> declineRequest(fromUid);
      });
    });
  }

  addFriendForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const uname=(addU.value||"").trim().toLowerCase();
    if(!unameRe.test(uname)){ alert("Invalid username"); return; }
    if(uname===me.username){ alert("That‚Äôs you üôÇ"); return; }
    const toUid=await usernameToUid(uname);
    if(!toUid){ alert("No such user"); return; }
    await setDoc(doc(db,"friend_reqs", toUid, "inbox", me.uid),{ from:me.uid, createdAt:serverTimestamp() });
    addU.value=""; alert("Friend request sent");
  });

  async function acceptRequest(fromUid){
    await setDoc(doc(db,"friends",me.uid,"list",fromUid),{ since:serverTimestamp() });
    await setDoc(doc(db,"friends",fromUid,"list",me.uid),{ since:serverTimestamp() });
    await deleteDoc(doc(db,"friend_reqs", me.uid, "inbox", fromUid));
    await loadFriends();
  }
  async function declineRequest(fromUid){ await deleteDoc(doc(db,"friend_reqs", me.uid, "inbox", fromUid)); }
  async function removeFriend(fuid){
    if(!confirm("Remove this friend?")) return;
    await deleteDoc(doc(db,"friends",me.uid,"list",fuid));
    await deleteDoc(doc(db,"friends",fuid,"list",me.uid));
    if(activeFriend===fuid){ activeFriend=null; activeChatId=null; msgsDiv.innerHTML=""; chatWith.textContent="Pick a friend to start chatting"; setChatTitle(""); }
    await loadFriends();
  }
  async function blockFriend(fuid){
    if(!confirm("Block this user? They won‚Äôt be able to DM you.")) return;
    await setDoc(doc(db,"blocks",me.uid,"list",fuid),{ since:serverTimestamp() });
    await removeFriend(fuid).catch(()=>{});
  }

  // ========== FIX STARTS HERE: ensure chat before reading/sending ==========
  function requireAuth(){
    const u = auth.currentUser;
    if(!u) throw new Error("Not signed in");
    return u.uid;
  }

  async function ensureChatAndPerms(friendUid){
    const myUid = requireAuth();
    const cid   = dmId(myUid, friendUid);
    const cref  = doc(db, "chats", cid);
    const snap  = await getDoc(cref);

    if (!snap.exists()) {
      await setDoc(cref, {
        members: [myUid, friendUid],
        createdAt: serverTimestamp(),
        memberNames: { [myUid]: me.displayName || me.username || "me", [friendUid]: activeFriendName || "friend" }
      });
      console.log("Chat created:", cid);
    } else {
      const data = snap.data() || {};
      const mems = Array.isArray(data.members) ? data.members : [];
      const must = [myUid, friendUid].sort().join(",");
      const have = mems.slice().sort().join(",");
      if (must !== have) {
        await setDoc(cref, { ...data, members: [myUid, friendUid] }, { merge: true });
        console.log("Chat members fixed:", cid);
      }
    }
    return cid;
  }

  async function openDM(friendUid, friendName, friendUname){
    try{
      activeFriend = friendUid;
      activeFriendName  = friendName || "";
      activeFriendUname = friendUname || "";
      activeChatId = await ensureChatAndPerms(friendUid);

      chatWith.textContent = `Chat with ${friendName||""} ${friendUname||""}`;
      setChatTitle(friendName, friendUname);
      await subscribeMessages(true);      // retry once if permission error
      subscribeTypingOfOther();
      closeDrawerIfMobile();
    }catch(err){
      console.error("openDM failed:", err);
      alert("Couldn‚Äôt open chat. Check Firestore rules are published and you‚Äôre signed in.");
    }
  }

  async function subscribeMessages(retryOnce=false){
    if(!activeChatId){
      msgsDiv.innerHTML=`<div class="small" style="padding:10px">Pick a friend.</div>`;
      return;
    }
    if(stopMsgs){ stopMsgs(); stopMsgs=null; }

    const qref=query(collection(db,"chats",activeChatId,"msgs"),orderBy("ts","asc"));
    stopMsgs = onSnapshot(qref, snap=>{
      msgsDiv.innerHTML="";
      snap.forEach(d=>{
        const data=d.data();
        renderMsg(d.id, data);
        // Mark messages from friend as seen
        if(data.uid !== me.uid){
          updateDoc(doc(db,"chats",activeChatId,"msgs",d.id), { [`seenBy.${me.uid}`]: serverTimestamp() }).catch(()=>{});
        }
      });
      msgsDiv.scrollTop = msgsDiv.scrollHeight;
      applySearchFilter();
    }, async (err)=>{
      console.warn("Subscribe error:", err);
      if (retryOnce && err.code === "permission-denied") {
        // Ensure chat again then retry once
        try { await ensureChatAndPerms(activeFriend); await subscribeMessages(false); }
        catch (e) { console.error("Retry failed:", e); alert("Can‚Äôt open messages (permissions)."); }
      } else {
        alert("Can‚Äôt read messages (permissions).");
      }
    });
  }
  // ========== FIX ENDS HERE ==========

  // Typing: my status
  textBox.addEventListener("input", ()=>{
    if(!activeChatId) return;
    setDoc(doc(db,"chats",activeChatId,"status",me.uid),{ typing:true, ts:serverTimestamp() },{merge:true});
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(()=>{
      setDoc(doc(db,"chats",activeChatId,"status",me.uid),{ typing:false, ts:serverTimestamp() },{merge:true});
    }, 1200);
  });

  // Typing: friend status
  function subscribeTypingOfOther(){
    if(stopTypingOther) stopTypingOther();
    if(!activeChatId || !activeFriend){ typingDiv.textContent=""; return; }
    stopTypingOther = onSnapshot(doc(db,"chats",activeChatId,"status",activeFriend),(d)=>{
      const st=d.data(); typingDiv.textContent = (st && st.typing) ? `${activeFriendName||"Friend"} is typing‚Ä¶` : "";
    });
  }

  // Quick emoji insert
  emojiBar.querySelectorAll(".emojiBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      textBox.value += btn.textContent;
      textBox.focus();
      const ev=new Event("input"); textBox.dispatchEvent(ev);
    });
  });

  // Send message (ensure chat first)
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    try{
      if(!activeFriend){ alert("Pick a friend on the left first."); return; }
      const t=textBox.value.replace(/\s+$/,""); if(!t) return;

      const cid = await ensureChatAndPerms(activeFriend);
      await addDoc(collection(db,"chats",cid,"msgs"),{
        t:t.slice(0,2000), n: me.displayName||me.username||"me", uid:me.uid, ts:serverTimestamp()
      });
      textBox.value="";
      setDoc(doc(db,"chats",cid,"status",me.uid),{ typing:false, ts:serverTimestamp() },{merge:true});
    }catch(err){
      console.error("send failed:", err);
      alert("Send failed (permissions).");
    }
  });

  // Reactions toggle (per user per message)
  async function toggleReaction(msgId, emoji){
    const rDoc = doc(db,"chats",activeChatId,"msgs",msgId,"reactions",me.uid);
    const existing = await getDoc(rDoc);
    const current = existing.data()?.e;
    if(current === emoji){
      await deleteDoc(rDoc).catch(()=>{});
    } else {
      await setDoc(rDoc, { e: emoji, uid: me.uid, ts: serverTimestamp() });
    }
  }

  // Render message + reactions + receipts + delete
  function renderMsg(id, m){
    const mine = m.uid === me.uid;
    const wrap=document.createElement("div"); wrap.className="msg"+(mine?" me":"");
    const col=document.createElement("div"); col.className="col";
    const bubble=document.createElement("div"); bubble.className="bubble"+(mine?" me":"");
    bubble.innerHTML=esc(m.t||"").replace(/:\)/g,"üòä").replace(/:\(/g,"üôÅ").replace(/<3/g,"‚ù§Ô∏è").replace(/\n/g,"<br>");
    const meta=document.createElement("div"); meta.className="meta";
    const time=m.ts?.toDate ? m.ts.toDate() : null;

    // Delivery / Seen
    let status = "";
    if(mine){
      const seenMap = m.seenBy || {};
      const seen = activeFriend && seenMap[activeFriend];
      status = seen ? " ‚Ä¢ seen" : " ‚Ä¢ delivered";
    }
    meta.textContent = `${m.n||"anon"} ‚Ä¢ ${time? time.toLocaleString():"sending‚Ä¶"}${status}`;

    // Reactions live
    const reactsDiv=document.createElement("div"); reactsDiv.className="reactions";
    onSnapshot(collection(db,"chats",activeChatId,"msgs",id,"reactions"), (snap)=>{
      const counts={}; let myEmoji=null;
      snap.forEach(d=>{ const r=d.data(); if(!r?.e) return; counts[r.e]=(counts[r.e]||0)+1; if(d.id===me.uid) myEmoji=r.e; });
      reactsDiv.innerHTML="";
      Object.entries(counts).sort((a,b)=>b[1]-a[1]).forEach(([emoji,count])=>{
        const pill=document.createElement("span");
        pill.className="pill"+(myEmoji===emoji?" mine":"");
        pill.textContent=`${emoji} ${count}`;
        pill.addEventListener("click", ()=> toggleReaction(id, emoji));
        reactsDiv.appendChild(pill);
      });
    });

    // Quick reaction row
    const quick=document.createElement("div"); quick.className="reactions";
    EMOJIS.forEach(e=>{
      const pill=document.createElement("span"); pill.className="pill"; pill.textContent=e;
      pill.addEventListener("click", ()=> toggleReaction(id, e));
      quick.appendChild(pill);
    });

    // Delete (mine only)
    if(mine){
      const del=document.createElement("button"); del.className="btn"; del.textContent="üóë Delete";
      del.title="Delete for everyone";
      del.onclick=async ()=>{
        if(confirm("Delete this message for everyone?")){
          await deleteDoc(doc(db,"chats",activeChatId,"msgs",id)).catch(err=>alert(err.message));
        }
      };
      col.appendChild(del);
    }

    col.appendChild(bubble);
    col.appendChild(meta);
    col.appendChild(reactsDiv);
    col.appendChild(quick);
    wrap.appendChild(col); msgsDiv.appendChild(wrap);
  }

  // ---- Search (client-side filter) ----
  searchBox.addEventListener("input", applySearchFilter);
  function applySearchFilter(){
    const q=(searchBox.value||"").toLowerCase();
    const children=[...msgsDiv.querySelectorAll(".msg")];
    if(!q){ children.forEach(el=>el.style.display=""); return; }
    children.forEach(el=>{
      const text=(el.querySelector(".bubble")?.innerText||"").toLowerCase();
      el.style.display = text.includes(q) ? "" : "none";
    });
  }
</script>
</body>
</html>