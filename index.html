<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QuickChat ‚Äì Accounts, DMs, Reactions, Seen</title>
<style>
  :root{--bg:#0b0f14;--panel:#121821;--muted:#93a1b1;--text:#e6edf3;--brand:#5da0ff;--border:#1e2633;--bubble:#0f1826;--bubbleMe:#0e203a;--bubbleMeBorder:#234a96}
  [data-theme="light"]{--bg:#f7f9fc;--panel:#fff;--muted:#5d6b7a;--text:#0b1625;--brand:#2b6cff;--border:#dde5ee;--bubble:#f1f5fb;--bubbleMe:#e8f0ff;--bubbleMeBorder:#bcd0ff}
  *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Arial}
  header{padding:12px;background:linear-gradient(180deg,rgba(14,20,32,.6),transparent)}
  .row{max-width:1100px;margin:0 auto;display:flex;gap:8px;align-items:center;padding:0 12px}
  h1{margin:0;font-size:18px;font-weight:700}
  #themeBtn{margin-left:auto;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);cursor:pointer}
  #logoutBtn{border:1px solid var(--border);background:transparent;color:var(--muted);border-radius:10px;padding:8px 12px;cursor:pointer}
  #badge{display:inline-flex;min-width:18px;height:18px;border-radius:9px;background:#ff5c5c;color:#fff;font-size:12px;align-items:center;justify-content:center;padding:0 6px;margin-left:6px}
  main{max-width:1100px;margin:0 auto;padding:14px;display:flex;gap:12px}
  #left{width:300px;min-width:240px;border:1px solid var(--border);background:var(--panel);border-radius:14px;overflow:hidden}
  #friendsHead{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border)}
  #friends{max-height:26vh;overflow:auto}
  .friend,.req{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border)}
  .friend:hover,.req:hover{background:rgba(255,255,255,.04)}
  .small{color:var(--muted);font-size:12px}
  .rowbtns{display:flex;gap:6px}
  .btn{padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer}
  .btn-warn{background:#ff5c5c;color:#1d0000;border-color:#e54}
  #reqsHead{padding:8px 12px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);font-weight:600;display:flex;align-items:center;gap:8px}
  #reqs{max-height:26vh;overflow:auto}
  #addFriendForm{display:flex;gap:6px;padding:10px 12px;border-top:1px solid var(--border)}
  #addU{flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text)}
  #card{flex:1;border:1px solid var(--border);background:var(--panel);border-radius:14px;overflow:hidden}
  #top{display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);flex-wrap:wrap}
  #chatWith{font-weight:700}
  #search{margin-left:auto;min-width:180px;padding:8px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text)}
  #msgs{height:58vh;min-height:320px;overflow:auto;padding:12px;scroll-behavior:smooth}
  .msg{margin:8px 0;max-width:86%;display:flex;gap:8px}
  .me{margin-left:auto;justify-content:flex-end}
  .bubble{display:inline-block;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--bubble)}
  .bubble.me{background:var(--bubbleMe);border-color:var(--bubbleMeBorder)}
  .meta{font-size:12px;color:var(--muted);margin-top:4px}
  .col{display:flex;flex-direction:column}
  .reactions{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:transparent;font-size:13px;color:var(--muted)}
  .pill.mine{border-color:var(--brand);color:var(--text)}
  #typing{padding:6px 12px;color:var(--muted);font-size:12px}
  form#form{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border);background:var(--bg)}
  input[type=text],input[type=password]{flex:1;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--bg);color:var(--text)}
  button{padding:12px 16px;border-radius:12px;border:1px solid var(--border);background:var(--brand);color:#071223;font-weight:700;cursor:pointer}
  @media (max-width:900px){#left{display:none}}
  /* Auth modal */
  #authModal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:9999}
  #authCard{width:360px;max-width:92vw;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px}
  #authCard h3{margin:6px 0 8px}
  #authCard .row{display:flex;flex-direction:column;gap:8px}
  #authErr{color:#ff6b6b;min-height:1em}
  /* Emoji picker (simple) */
  #emojiBar{display:flex;gap:6px;padding:6px 12px;border-top:1px dashed var(--border)}
  .emojiBtn{font-size:20px;line-height:1;border:1px solid var(--border);background:transparent;border-radius:10px;padding:6px 8px;cursor:pointer}
</style>
</head>
<body>
  <!-- Auth (username + password) -->
  <div id="authModal" style="display:none">
    <div id="authCard">
      <h3>Sign in</h3>
      <div class="row">
        <input id="username" placeholder="Username (a-z, 0-9, _)" maxlength="20">
        <input id="password" type="password" placeholder="Password (min 6)">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="loginBtn"  style="flex:1">Log in</button>
          <button id="signupBtn" style="flex:1">Create account</button>
        </div>
        <div id="authErr"></div>
      </div>
    </div>
  </div>

  <header>
    <div class="row">
      <h1>QuickChat</h1>
      <div id="meTag" class="small"></div>
      <button id="themeBtn" aria-pressed="false">üåô Dark</button>
      <button id="logoutBtn" title="Sign out">Sign out</button>
    </div>
  </header>

  <main id="app">
    <!-- Left: friends & requests -->
    <aside id="left">
      <div id="friendsHead">
        <strong>Friends</strong>
        <span style="margin-left:auto" class="small">Requests <span id="badge" style="display:none">0</span></span>
      </div>
      <div id="friends"></div>
      <div id="reqsHead">Incoming requests</div>
      <div id="reqs"></div>
      <form id="addFriendForm">
        <input id="addU" placeholder="Add by username" />
        <button>Add</button>
      </form>
    </aside>

    <!-- Right: chat -->
    <section id="card">
      <div id="top">
        <div id="chatWith">Pick a friend to start chatting</div>
        <input id="search" placeholder="Search messages‚Ä¶" />
      </div>
      <div id="msgs" aria-live="polite"></div>
      <div id="typing"></div>
      <div id="emojiBar">
        <button class="emojiBtn">üòÄ</button><button class="emojiBtn">üòÇ</button><button class="emojiBtn">‚ù§Ô∏è</button><button class="emojiBtn">üëç</button><button class="emojiBtn">üî•</button><button class="emojiBtn">üòÆ</button>
      </div>
      <form id="form" autocomplete="off">
        <input id="text" type="text" placeholder="Type a message‚Ä¶  (Enter to send, Shift+Enter = newline)" />
        <button id="send" type="submit">Send ‚Üµ</button>
      </form>
    </section>
  </main>

<script type="module">
  // ---- Firebase config (yours) ----
  const firebaseConfig = {
    apiKey: "AIzaSyDyO8Um7UzvOOm0ki7WvGuwiqbNAyS8ro8",
    authDomain: "calculator-l.firebaseapp.com",
    projectId: "calculator-l",
    storageBucket: "calculator-l.firebasestorage.app",
    messagingSenderId: "55334370820",
    appId: "1:55334370820:web:5f38db1aeffe33d44a3f51",
    measurementId: "G-FGK3V66H34"
  };

  // ---- Imports ----
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot,
    query, orderBy, serverTimestamp, deleteDoc, getDocs, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ---- UI ----
  const $ = id => document.getElementById(id);
  const authModal=$("authModal"), usernameEl=$("username"), passwordEl=$("password"), loginBtn=$("loginBtn"), signupBtn=$("signupBtn"), authErr=$("authErr");
  const themeBtn=$("themeBtn"), logoutBtn=$("logoutBtn"), meTag=$("meTag");
  const friendsDiv=$("friends"), reqsDiv=$("reqs"), addFriendForm=$("addFriendForm"), addU=$("addU"), badge=$("badge");
  const chatWith=$("chatWith"), msgsDiv=$("msgs"), form=$("form"), textBox=$("text"), typingDiv=$("typing"), searchBox=$("search");
  const emojiBar=document.getElementById("emojiBar");

  // ---- Theme ----
  const savedTheme = localStorage.qc_theme || "dark";
  document.documentElement.setAttribute("data-theme", savedTheme);
  themeBtn.textContent = savedTheme==="dark" ? "üåô Dark" : "‚òÄÔ∏è Light";
  themeBtn.addEventListener("click", ()=>{
    const next = document.documentElement.getAttribute("data-theme")==="dark" ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", next);
    localStorage.qc_theme = next;
    themeBtn.textContent = next==="dark" ? "üåô Dark" : "‚òÄÔ∏è Light";
  });

  // ---- Username-login helpers ----
  const unameRe = /^[a-z0-9_]{3,20}$/;
  const unameToEmail = u => `${u.toLowerCase()}@app.local`;

  // ---- State ----
  let me = { uid:null, username:null, displayName:null };
  let activeFriend = null;          // friend's uid
  let activeFriendName = "";
  let activeFriendUname = "";
  let activeChatId = null;          // chats/{uidA_uidB}
  let stopMsgs = null, stopReqs = null, stopTypingOther = null;
  let localCache = [];              // for search
  let typingTimeout = null;
  const EMOJIS = ["üòÄ","üòÇ","‚ù§Ô∏è","üëç","üî•","üòÆ"];

  function dmId(a,b){ return [a,b].sort().join("_"); }

  // ---- Auth modal ----
  function showAuth(msg=""){ authErr.textContent=msg; authModal.style.display="flex"; }
  function hideAuth(){ authModal.style.display="none"; }

  signupBtn.onclick = async ()=>{
    authErr.textContent="";
    const u=(usernameEl.value||"").trim().toLowerCase();
    const p=passwordEl.value;
    if(!unameRe.test(u)){ authErr.textContent="Username 3‚Äì20 chars: a‚Äìz 0‚Äì9 _"; return; }
    if(p.length<6){ authErr.textContent="Password ‚â• 6"; return; }
    try{
      const cred=await createUserWithEmailAndPassword(auth, unameToEmail(u), p);
      await updateProfile(cred.user,{displayName:u});
      await setDoc(doc(db,"users",cred.user.uid),{ uid:cred.user.uid, username:u, displayName:u, createdAt:serverTimestamp() });
      await setDoc(doc(db,"usernames",u),{ uid:cred.user.uid, createdAt:serverTimestamp() });
      hideAuth();
    }catch(e){ authErr.textContent=e.message; }
  };

  loginBtn.onclick = async ()=>{
    authErr.textContent="";
    const u=(usernameEl.value||"").trim().toLowerCase();
    const p=passwordEl.value;
    if(!unameRe.test(u)){ authErr.textContent="Enter username"; return; }
    try{ await signInWithEmailAndPassword(auth, unameToEmail(u), p); hideAuth(); }
    catch(e){ authErr.textContent="Login failed: "+e.message; }
  };

  logoutBtn.onclick = async ()=>{ await signOut(auth); location.reload(); };

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ showAuth(); return; }
    const udoc=await getDoc(doc(db,"users",user.uid));
    const data=udoc.data()||{};
    me.uid=user.uid; me.username=data.username||user.displayName?.toLowerCase(); me.displayName=data.displayName||me.username||"me";
    meTag.textContent = `@${me.username}`;
    hideAuth();
    await loadFriends();
    subscribeRequestsBadge();
  });

  // ---- Friends & Requests ----
  async function usernameToUid(uname){
    const d=await getDoc(doc(db,"usernames",uname.toLowerCase()));
    return d.exists()? d.data().uid : null;
  }

  async function loadFriends(){
    friendsDiv.innerHTML="";
    const snaps=await getDocs(collection(db,"friends",me.uid,"list"));
    if(snaps.empty){ friendsDiv.innerHTML=`<div class="small" style="padding:10px">No friends yet. Add by username below.</div>`; }
    for(const d of snaps.docs){
      const fuid=d.id;
      const u=await getDoc(doc(db,"users",fuid));
      const name=u.data()?.displayName||"Friend";
      const uname=u.data()?.username ? "@"+u.data().username : "";
      const row=document.createElement("div");
      row.className="friend";
      row.innerHTML=`<div><div>${name}</div><div class="small">${uname}</div></div>
        <div class="rowbtns">
          <button class="btn" id="open_${fuid}">Open</button>
          <button class="btn" id="rm_${fuid}">Remove</button>
          <button class="btn btn-warn" id="blk_${fuid}">Block</button>
        </div>`;
      friendsDiv.appendChild(row);
      $("open_"+fuid).onclick=()=> openDM(fuid,name,uname);
      $("rm_"+fuid).onclick=()=> removeFriend(fuid);
      $("blk_"+fuid).onclick=()=> blockFriend(fuid);
    }
  }

  function subscribeRequestsBadge(){
    if(stopReqs) stopReqs();
    const inbox=collection(db,"friend_reqs", me.uid, "inbox");
    stopReqs = onSnapshot(inbox,(snap)=>{
      const n=snap.size; badge.textContent=String(n);
      badge.style.display = n? "inline-flex":"none";
      // render list
      reqsDiv.innerHTML="";
      if(!n){ reqsDiv.innerHTML=`<div class="small" style="padding:10px">No requests</div>`; return; }
      snap.forEach(async d=>{
        const fromUid=d.id;
        const from=await getDoc(doc(db,"users",fromUid));
        const uname=from.data()?.username||"user";
        const r=document.createElement("div"); r.className="req";
        r.innerHTML=`<div>@${uname}</div>
          <div class="rowbtns">
            <button class="btn" id="acc_${fromUid}">Accept</button>
            <button class="btn" id="dec_${fromUid}">Decline</button>
          </div>`;
        reqsDiv.appendChild(r);
        $("acc_"+fromUid).onclick=()=> acceptRequest(fromUid);
        $("dec_"+fromUid).onclick=()=> declineRequest(fromUid);
      });
    });
  }

  addFriendForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const uname=(addU.value||"").trim().toLowerCase();
    if(!unameRe.test(uname)){ alert("Invalid username"); return; }
    if(uname===me.username){ alert("That‚Äôs you üôÇ"); return; }
    const toUid=await usernameToUid(uname);
    if(!toUid){ alert("No such user"); return; }
    await setDoc(doc(db,"friend_reqs", toUid, "inbox", me.uid),{ from:me.uid, createdAt:serverTimestamp() });
    addU.value=""; alert("Friend request sent");
  });

  async function acceptRequest(fromUid){
    await setDoc(doc(db,"friends",me.uid,"list",fromUid),{ since:serverTimestamp() });
    await setDoc(doc(db,"friends",fromUid,"list",me.uid),{ since:serverTimestamp() });
    await deleteDoc(doc(db,"friend_reqs", me.uid, "inbox", fromUid));
    await loadFriends();
  }
  async function declineRequest(fromUid){
    await deleteDoc(doc(db,"friend_reqs", me.uid, "inbox", fromUid));
  }
  async function removeFriend(fuid){
    if(!confirm("Remove this friend?")) return;
    await deleteDoc(doc(db,"friends",me.uid,"list",fuid));
    await deleteDoc(doc(db,"friends",fuid,"list",me.uid));
    if(activeFriend===fuid){ activeFriend=null; activeChatId=null; msgsDiv.innerHTML=""; chatWith.textContent="Pick a friend to start chatting"; }
    await loadFriends();
  }
  async function blockFriend(fuid){
    if(!confirm("Block this user? They won‚Äôt be able to DM you.")) return;
    await setDoc(doc(db,"blocks",me.uid,"list",fuid),{ since:serverTimestamp() });
    // Optionally remove from friends lists:
    await removeFriend(fuid).catch(()=>{});
  }

  // ---- DMs + Typing + Search + Reactions + Seen ----
  function esc(s){ return s.replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

  async function ensureChat(a,b){
    const cid=dmId(a,b);
    const cref=doc(db,"chats",cid);
    const cdoc=await getDoc(cref);
    if(!cdoc.exists()){
      const au=await getDoc(doc(db,"users",a)); const bu=await getDoc(doc(db,"users",b));
      await setDoc(cref,{ members:[a,b], createdAt:serverTimestamp(), memberNames:{[a]:au.data()?.displayName||"me",[b]:bu.data()?.displayName||"friend"} });
    }
    return cid;
  }

  async function openDM(friendUid, friendName, friendUname){
    activeFriend = friendUid;
    activeFriendName = friendName || "";
    activeFriendUname = friendUname || "";
    activeChatId = await ensureChat(me.uid, friendUid);
    chatWith.textContent = `Chat with ${friendName||""} ${friendUname||""}`;
    subscribeMessages();
    subscribeTypingOfOther();
  }

  function subscribeMessages(){
    if(!activeChatId){ msgsDiv.innerHTML=`<div class="small" style="padding:10px">Pick a friend.</div>`; return; }
    if(stopMsgs){ stopMsgs(); stopMsgs=null; }
    localCache = [];
    const qref=query(collection(db,"chats",activeChatId,"msgs"),orderBy("ts","asc"));
    stopMsgs = onSnapshot(qref, snap=>{
      localCache = [];
      msgsDiv.innerHTML="";
      snap.forEach(d=>{
        const data=d.data();
        localCache.push({id:d.id, ...data});
        renderMsg(d.id, data);
        // Mark messages from friend as seen
        if(data.uid !== me.uid){
          updateDoc(doc(db,"chats",activeChatId,"msgs",d.id), { [`seenBy.${me.uid}`]: serverTimestamp() }).catch(()=>{});
        }
      });
      msgsDiv.scrollTop = msgsDiv.scrollHeight;
      applySearchFilter();
    });
  }

  // Typing: my status
  textBox.addEventListener("input", ()=>{
    if(!activeChatId) return;
    setDoc(doc(db,"chats",activeChatId,"status",me.uid),{ typing:true, ts:serverTimestamp() },{merge:true});
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(()=>{
      setDoc(doc(db,"chats",activeChatId,"status",me.uid),{ typing:false, ts:serverTimestamp() },{merge:true});
    }, 1200);
  });

  // Typing: friend status
  function subscribeTypingOfOther(){
    if(stopTypingOther) stopTypingOther();
    if(!activeChatId || !activeFriend){ typingDiv.textContent=""; return; }
    stopTypingOther = onSnapshot(doc(db,"chats",activeChatId,"status",activeFriend),(d)=>{
      const st=d.data(); typingDiv.textContent = (st && st.typing) ? `${activeFriendName||"Friend"} is typing‚Ä¶` : "";
    });
  }

  // Send message + quick emoji insert
  emojiBar.querySelectorAll(".emojiBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      textBox.value += btn.textContent;
      textBox.focus();
      const ev=new Event("input"); textBox.dispatchEvent(ev);
    });
  });

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!activeChatId){ alert("Pick a friend on the left first."); return; }
    const t=textBox.value.replace(/\s+$/,""); if(!t) return;
    await addDoc(collection(db,"chats",activeChatId,"msgs"),{
      t:t.slice(0,2000), n: me.displayName||me.username||"me", uid:me.uid, ts:serverTimestamp()
    });
    textBox.value="";
    setDoc(doc(db,"chats",activeChatId,"status",me.uid),{ typing:false, ts:serverTimestamp() },{merge:true});
  });

  // Reactions toggle (per user per message)
  async function toggleReaction(msgId, emoji){
    const rDoc = doc(db,"chats",activeChatId,"msgs",msgId,"reactions",me.uid);
    // Simple set (click same emoji pill to overwrite); to remove, click your pill in list again:
    const existing = await getDoc(rDoc);
    const current = existing.data()?.e;
    if(current === emoji){
      await deleteDoc(rDoc).catch(()=>{});
    } else {
      await setDoc(rDoc, { e: emoji, uid: me.uid, ts: serverTimestamp() });
    }
  }

  // Render message + reactions + receipts
  function renderMsg(id, m){
    const mine = m.uid === me.uid;
    const wrap=document.createElement("div"); wrap.className="msg"+(mine?" me":"");
    const col=document.createElement("div"); col.className="col";
    const bubble=document.createElement("div"); bubble.className="bubble"+(mine?" me":"");
    bubble.innerHTML=esc(m.t||"").replace(/:\)/g,"üòä").replace(/:\(/g,"üôÅ").replace(/<3/g,"‚ù§Ô∏è").replace(/\n/g,"<br>");
    const meta=document.createElement("div"); meta.className="meta";
    const time=m.ts?.toDate ? m.ts.toDate() : null;

    // Delivery / Seen
    let status = "";
    if(mine){
      const seenMap = m.seenBy || {};
      const seen = activeFriend && seenMap[activeFriend];
      status = seen ? " ‚Ä¢ seen" : " ‚Ä¢ delivered";
    }

    meta.textContent = `${m.n||"anon"} ‚Ä¢ ${time? time.toLocaleString():"sending‚Ä¶"}${status}`;

    // Reactions view
    const reactsDiv=document.createElement("div"); reactsDiv.className="reactions";
    // Live reactions subcollection
    onSnapshot(collection(db,"chats",activeChatId,"msgs",id,"reactions"), (snap)=>{
      const counts={}; let myEmoji=null;
      snap.forEach(d=>{ const r=d.data(); if(!r?.e) return; counts[r.e]=(counts[r.e]||0)+1; if(d.id===me.uid) myEmoji=r.e; });
      reactsDiv.innerHTML="";
      Object.entries(counts).sort((a,b)=>b[1]-a[1]).forEach(([emoji,count])=>{
        const pill=document.createElement("span");
        pill.className="pill"+(myEmoji===emoji?" mine":"");
        pill.textContent=`${emoji} ${count}`;
        pill.addEventListener("click", ()=> toggleReaction(id, emoji));
        reactsDiv.appendChild(pill);
      });
    });

    // Quick reaction row (tap to add)
    const quick=document.createElement("div"); quick.className="reactions";
    EMOJIS.forEach(e=>{
      const pill=document.createElement("span"); pill.className="pill"; pill.textContent=e;
      pill.addEventListener("click", ()=> toggleReaction(id, e));
      quick.appendChild(pill);
    });

    // Delete (mine only)
    if(mine){
      const del=document.createElement("button"); del.className="btn"; del.textContent="üóë Delete";
      del.title="Delete for everyone";
      del.onclick=async ()=>{
        if(confirm("Delete this message for everyone?")){
          await deleteDoc(doc(db,"chats",activeChatId,"msgs",id)).catch(err=>alert(err.message));
        }
      };
      col.appendChild(del);
    }

    col.appendChild(bubble);
    col.appendChild(meta);
    col.appendChild(reactsDiv);
    col.appendChild(quick);
    wrap.appendChild(col); msgsDiv.appendChild(wrap);
  }

  // ---- Search (client-side filter) ----
  searchBox.addEventListener("input", applySearchFilter);
  function applySearchFilter(){
    const q=(searchBox.value||"").toLowerCase();
    const children=[...msgsDiv.querySelectorAll(".msg")];
    if(!q){ children.forEach(el=>el.style.display=""); return; }
    // Match against message text (bubble innerText)
    children.forEach(el=>{
      const text=(el.querySelector(".bubble")?.innerText||"").toLowerCase();
      el.style.display = text.includes(q) ? "" : "none";
    });
  }
</script>
</body>
</html>
